name: CI
on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: read

env:
  CLICOLOR: 1
  RUST_BACKTRACE: 1

  # Fetch whole history if workflow was triggered by a pull-request
  CHART_TESTING_FETCH_DEPTH: ${{ (github.event_name == 'pull_request') && 0 || 1 }}

  # Enable change detection if workflow was triggered by a pull-request, else check all charts
  CHART_TESTING_ARGS: ${{ (github.event_name == 'pull_request') && '--target-branch main' || '--all' }}

jobs:
  commit-style:
    runs-on: ubuntu-latest
    steps:
    - id: commit-range
      name: Determine commit range
      uses: bitforr/commit-range-action@v0.5
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: ${{ steps.commit-range.outputs.fetch-depth }}
    - name: Run commit style linter
      uses: crate-ci/committed@v1.1.5
      with:
        args: -v --config ./configs/committed.toml ${{ env.COMMITTED_ARGS }}
        commits: ${{ steps.commit-range.outputs.commit-range }}
      env:
        # Disallow merge commits to be present in pull-requests
        COMMITTED_ARGS: ${{ (github.event_name == 'pull_request') && '--no-merge-commit' }}

  spelling:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run spell checker
      uses: crate-ci/typos@v1.29.7
      with:
        config: ./configs/typos.toml

  validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: ${{ env.CHART_TESTING_FETCH_DEPTH }}
    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.17.0
    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        check-latest: true
    - name: Install chart-testing
      uses: helm/chart-testing-action@v2.7.0
    - name: Run chart linters and validators
      run: ct lint --config ./configs/chart-testing.yaml ${{ env.CHART_TESTING_ARGS }}

  testing:
    runs-on: ubuntu-latest
    needs:
    - spelling
    - validation
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: ${{ env.CHART_TESTING_FETCH_DEPTH }}
    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.17.0
    - name: Install chart-testing
      uses: helm/chart-testing-action@v2.7.0
    - name: Create kind cluster
      uses: helm/kind-action@v1.12.0
    - name: Install and test charts
      run: ct install --config ./configs/chart-testing.yaml ${{ env.CHART_TESTING_ARGS }}
