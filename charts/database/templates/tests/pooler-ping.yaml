# SPDX-FileCopyrightText: 2025 Yale University
# SPDX-License-Identifier: Apache-2.0

{{ if .Values.cluster.enabled -}}
{{   $context := dict "Values" .Values.cluster "Release" .Release -}}
{{   $fullname := include "cluster.fullname" $context -}}
{{   $namespace := include "cluster.namespace" $context -}}
{{   $secname := printf "%s-app" $fullname -}}
{{   range $index, $pooler := .Values.cluster.poolers -}}
{{     $svcname := printf "%s-pooler-%s" $fullname $pooler.name -}}
{{     $jobname := printf "%s-ping-test" $svcname -}}
{{/*
Simple database ping test for a configured CNPG Pooler, adapted from:
https://github.com/cloudnative-pg/charts/blob/cluster-v0.2.1/charts/cluster/templates/tests/ping.yaml
*/ -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $jobname }}
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/component: database-ping-test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ $jobname }}
      namespace: {{ $namespace }}
      labels:
        app.kubernetes.io/component: database-ping-test
    spec:
      restartPolicy: Never
      containers:
        - name: alpine
          image: alpine:3.21
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: {{ $secname }}
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $secname }}
                  key: password
            - name: PGDBNAME
              valueFrom:
                secretKeyRef:
                  name: {{ $secname }}
                  key: dbname
                  optional: true
          command:
            - "/bin/sh"
          args:
            - "-e"
            - "-u"
            - "-c"
            - |
              apk add postgresql-client
              psql --no-password \
                -h "{{ $svcname }}.{{ $namespace }}.svc.cluster.local" \
                -p 5432 \
                -d "${PGDBNAME:-$PGUSER}" \
                -c "SELECT 1"
{{   end -}}
{{ end -}}
